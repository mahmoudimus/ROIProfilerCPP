<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Regions Of Interest (ROI) Profiler: /Users/maximilian/clang-llvm/clang/tools/clang-offload-wrapper/ClangOffloadWrapper.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="DragonMedium.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Regions Of Interest (ROI) Profiler
   &#160;<span id="projectnumber">1.2</span>
   </div>
   <div id="projectbrief">roiwpc [-o output][--stmt statementid] &lt;source&gt;</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_c691aa47357890e68fbaa3047f93d72f.html">clang-offload-wrapper</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">ClangOffloadWrapper.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;clang/Basic/Version.h&quot;</code><br />
<code>#include &quot;llvm/ADT/ArrayRef.h&quot;</code><br />
<code>#include &quot;llvm/ADT/Triple.h&quot;</code><br />
<code>#include &quot;llvm/Bitcode/BitcodeWriter.h&quot;</code><br />
<code>#include &quot;llvm/IR/Constants.h&quot;</code><br />
<code>#include &quot;llvm/IR/GlobalVariable.h&quot;</code><br />
<code>#include &quot;llvm/IR/IRBuilder.h&quot;</code><br />
<code>#include &quot;llvm/IR/LLVMContext.h&quot;</code><br />
<code>#include &quot;llvm/IR/Module.h&quot;</code><br />
<code>#include &quot;llvm/Support/CommandLine.h&quot;</code><br />
<code>#include &quot;llvm/Support/Errc.h&quot;</code><br />
<code>#include &quot;llvm/Support/Error.h&quot;</code><br />
<code>#include &quot;llvm/Support/ErrorOr.h&quot;</code><br />
<code>#include &quot;llvm/Support/FileSystem.h&quot;</code><br />
<code>#include &quot;llvm/Support/MemoryBuffer.h&quot;</code><br />
<code>#include &quot;llvm/Support/Signals.h&quot;</code><br />
<code>#include &quot;llvm/Support/ToolOutputFile.h&quot;</code><br />
<code>#include &quot;llvm/Support/WithColor.h&quot;</code><br />
<code>#include &quot;llvm/Support/raw_ostream.h&quot;</code><br />
<code>#include &quot;llvm/Transforms/Utils/ModuleUtils.h&quot;</code><br />
<code>#include &lt;cassert&gt;</code><br />
<code>#include &lt;cstdint&gt;</code><br />
</div>
<p><a href="_clang_offload_wrapper_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a217dbf8b442f20279ea00b898af96f52"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_clang_offload_wrapper_8cpp.html#a217dbf8b442f20279ea00b898af96f52">main</a> (int argc, const char **argv)</td></tr>
<tr class="separator:a217dbf8b442f20279ea00b898af96f52"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of the offload wrapper tool. It takes offload target binaries as input and creates wrapper bitcode file containing target binaries packaged as data. Wrapper bitcode also includes initialization code which registers target binaries in offloading runtime at program startup. </p>

<p class="definition">Definition in file <a class="el" href="_clang_offload_wrapper_8cpp_source.html">ClangOffloadWrapper.cpp</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a217dbf8b442f20279ea00b898af96f52"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a217dbf8b442f20279ea00b898af96f52">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="_clang_offload_wrapper_8cpp_source.html#l00312">312</a> of file <a class="el" href="_clang_offload_wrapper_8cpp_source.html">ClangOffloadWrapper.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                      {</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  sys::PrintStackTraceOnErrorSignal(argv[0]);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  cl::HideUnrelatedOptions(ClangOffloadWrapperCategory);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  cl::SetVersionPrinter([](raw_ostream &amp;OS) {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    OS &lt;&lt; clang::getClangToolFullVersion(<span class="stringliteral">&quot;clang-offload-wrapper&quot;</span>) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  });</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  cl::ParseCommandLineOptions(</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      argc, argv,</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      <span class="stringliteral">&quot;A tool to create a wrapper bitcode for offload target binaries. Takes &quot;</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      <span class="stringliteral">&quot;offload\ntarget binaries as input and produces bitcode file containing &quot;</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      <span class="stringliteral">&quot;target binaries packaged\nas data and initialization code which &quot;</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      <span class="stringliteral">&quot;registers target binaries in offload runtime.\n&quot;</span>);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160; </div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  <span class="keywordflow">if</span> (Help) {</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    cl::PrintHelpMessage();</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; </div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <span class="keyword">auto</span> reportError = [argv](Error E) {</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    logAllUnhandledErrors(std::move(E), WithColor::error(errs(), argv[0]));</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  };</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordflow">if</span> (Triple(Target).getArch() == Triple::UnknownArch) {</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    reportError(createStringError(</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        errc::invalid_argument, <span class="stringliteral">&quot;&#39;&quot;</span> + Target + <span class="stringliteral">&quot;&#39;: unsupported target triple&quot;</span>));</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="comment">// Read device binaries.</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  SmallVector&lt;std::unique_ptr&lt;MemoryBuffer&gt;, 4u&gt; Buffers;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  SmallVector&lt;ArrayRef&lt;char&gt;, 4u&gt; Images;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  Buffers.reserve(Inputs.size());</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  Images.reserve(Inputs.size());</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">const</span> std::string &amp;File : Inputs) {</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    ErrorOr&lt;std::unique_ptr&lt;MemoryBuffer&gt;&gt; BufOrErr =</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        MemoryBuffer::getFileOrSTDIN(File);</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">if</span> (!BufOrErr) {</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      reportError(createFileError(File, BufOrErr.getError()));</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;      <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    }</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keyword">const</span> std::unique_ptr&lt;MemoryBuffer&gt; &amp;Buf =</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        Buffers.emplace_back(std::move(*BufOrErr));</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    Images.emplace_back(Buf-&gt;getBufferStart(), Buf-&gt;getBufferSize());</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="comment">// Create the output file to write the resulting bitcode to.</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  std::error_code EC;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  ToolOutputFile Out(Output, EC, sys::fs::OF_None);</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  <span class="keywordflow">if</span> (EC) {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    reportError(createFileError(Output, EC));</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  }</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="comment">// Create a wrapper for device binaries and write its bitcode to the file.</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  WriteBitcodeToFile(BinaryWrapper(Target).wrapBinaries(</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                         makeArrayRef(Images.data(), Images.size())),</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                     Out.os());</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordflow">if</span> (Out.os().has_error()) {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    reportError(createFileError(Output, Out.os().error()));</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  }</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160; </div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="comment">// Success.</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  Out.keep();</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
